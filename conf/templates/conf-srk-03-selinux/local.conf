#
# SELinux Embedded System Configuration
#
# This configuration is specifically designed for building
# core-image-tiny-initramfs-srk-10-selinux with systemd and SELinux support
#

# Machine and Distribution Configuration
MACHINE = "beaglebone-yocto"
DISTRO = "poky"
DISK2="/media/srk2cob/disk2/"
DL_DIR ?= "${DISK2}/downloads"
SSTATE_DIR ?= "${DISK2}/sstate-cache"

# SELinux and systemd support
DISTRO_FEATURES:append = " selinux systemd pam"
DISTRO_FEATURES:remove = " sysvinit"
VIRTUAL-RUNTIME_init_manager = "systemd"

# SELinux policy configuration
PREFERRED_VERSION_refpolicy = "2.%"

# Download and cache directories


# Debug and development features
EXTRA_IMAGE_FEATURES ?= "debug-tweaks"
USER_CLASSES ?= "buildstats"

# Disk space monitoring
BB_DISKMON_DIRS ??= "\
    STOPTASKS,${TMPDIR},1G,100K \
    STOPTASKS,${DL_DIR},1G,100K \
    STOPTASKS,${SSTATE_DIR},1G,100K \
    STOPTASKS,/tmp,100M,100K \
    HALT,${TMPDIR},100M,1K \
    HALT,${DL_DIR},100M,1K \
    HALT,${SSTATE_DIR},100M,1K \
    HALT,/tmp,10M,1K"

# Patch resolution
PATCHRESOLVE = "noop"

# Configuration version
CONF_VERSION = "2"

# Build tools integration
INHERIT += "toaster buildhistory"

# Network settings for deployment


# Remove unnecessary dependencies for initramfs
EXTRA_IMAGEDEPENDS:remove = " virtual/bootloader qemu-native qemu-helper-native"
# Use our custom kernel
PREFERRED_PROVIDER_virtual/kernel = "linux-yocto"


# =================================================
# Minimal SELinux Settings
# =================================================
DISTRO_FEATURES:append = " selinux pam systemd usrmerge"
PREFERRED_PROVIDER_virtual/refpolicy ?= "refpolicy-targeted"
PREFERRED_VERSION_refpolicy = "2.%"

# Install SELinux userland libraries and policy
IMAGE_INSTALL:append = " libselinux refpolicy-targeted"

# Kernel must support SELinux
PREFERRED_PROVIDER_virtual/kernel = "linux-yocto-srk"

DISTRO_FEATURES:remove = "x11 wayland opengl vulkan"
PREFERRED_PROVIDER_virtual/bootloader = ""
IMAGE_INSTALL:remove = "libx11 libgl mesa"

EXTRA_IMAGEDEPENDS:remove = " virtual/bootloader qemu-native qemu-helper-native"
DISTRO_FEATURES:remove = "package-management"
